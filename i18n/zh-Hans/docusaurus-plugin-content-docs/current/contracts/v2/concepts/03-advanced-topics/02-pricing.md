---
id: pricing
title: 定价
---

# 价格如何确定？

正如我们在[协议概览](../protocol-overview/how-uniswap-works)中学到的，Uniswap 上的每一对货币实际上都由一个流动性池支持。流动性池是智能合约，持有两种独特代币的余额，并强制执行有关存入和提取它们的规则。主要规则是[常数乘积公式](../protocol-overview/glossary#constant-product-formula)。当一种代币被提取（买入）时，必须按比例存入（卖出）另一种代币以保持常数不变。池中代币的比例，结合常数乘积公式，最终决定了交易执行的价格。

# Uniswap 如何处理价格

在 Uniswap V1 中，交易总是在执行时刻计算出的“最佳可能”价格下进行。有些令人困惑的是，这种计算实际上是通过两种不同的公式之一完成的，具体取决于交易是否指定了确切的_输入_或_输出_金额。功能上，这两个函数之间的差异微乎其微，但存在差异的事实增加了概念上的复杂性。最初尝试在 V2 中同时支持这两个函数证明不够优雅，于是做出了决定**不在核心中提供任何定价函数**。相反，对每笔交易后直接检查不变量是否满足（考虑到费用）。这意味着，V2 对无需依赖定价函数来_同时也强制执行不变量_，而是简单且透明地确保自身的安全，实现了很好的关注点分离。一个下游的好处是，V2 对将更自然地支持可能出现的其他类型的交易（例如，在执行时刻交易到特定价格）。

从高层次上看，在 Uniswap V2 中，_交易必须在周边定价_。好消息是[库](../../reference/smart-contracts/library)提供了多种旨在使这一过程非常简单的函数，而[路由器](../../reference/smart-contracts/router-02)中的所有交换函数都是考虑到这一点设计的。

# 定价交易

在 Uniswap 上交换代币时，通常希望以_确切的输入金额_换取尽可能多的输出代币，或者为_确切的输出金额_支付尽可能少的输入代币。为了计算这些金额，合同必须查找一对的_当前储备_，以了解当前的价格是多少。然而，如果没有访问外部价格的能力，就_不安全_进行此查找并依赖结果。

假设一个智能合约天真地想向 DAI/WETH 对发送 10 DAI，并以当前储备比率所能获得的尽可能多的 WETH。如果当调用时，这个天真的智能合约只是查看当前价格并执行交易，它将_容易受到抢先交易攻击，并且很可能遭受经济损失_。来看看为什么：考虑一个恶意行为者在交易确认前看到了这笔交易。他们可以在天真的交易通过之前立即执行一个大幅改变 DAI/WETH 价格的交换，等待天真的交易以不利的汇率执行，然后再次交换以将价格恢复到天真的交易之前的水平。这种攻击相对便宜且风险低，通常可以以盈利的方式执行。

为了防止这类攻击，提交交易时_必须具备对其交易应执行的“公平”价格的知识_至关重要。换句话说，交易需要访问_预言机_，以确保他们从 Uniswap 获得的最佳执行接近预言机认为的“真实”价格。虽然这听起来可能很复杂，但预言机可以像_链下观察一对当前市场价格_一样简单。由于套利的存在，通常情况下，一对在区块内的储备比率接近“真实”的市场价格。因此，如果用户在提交交易时考虑到这一点，他们可以确保因抢先交易造成的损失被严格限制。这就是 Uniswap 前端如何确保交易安全的方式。它根据观察到的区块内价格计算最优的输入/输出金额，并使用路由器执行交易，保证交易将以不低于观察到的区块内比率的`x`％执行，其中 `x` 是用户指定的滑点容差（默认为 0.5%）。

当然，还有其他预言机选项，包括[原生 V2 预言机](../core-concepts/oracles)。

## 确切输入

如果你想以确切数量的输入代币换取尽可能多的输出代币，你将想要使用[getAmountsOut](../../reference/smart-contracts/router-02#getamountout)。等效的 SDK 函数是[getOutputAmount](../../../../sdk/2.0.0/reference/pair#getoutputamount)，或[minimumAmountOut](../../../../sdk/2.0.0/reference/trade#minimumamountout-since-204)用于滑点计算。

## 确切输出

如果你想以尽可能少的输入代币换取确切数量的输出代币，你将想要使用[getAmountsIn](../../reference/smart-contracts/router-02#getamountsin)。等效的 SDK 函数是[getInputAmount](../../../../sdk/2.0.0/reference/pair#getinputamount)，或[maximumAmountIn](../../../../sdk/2.0.0/reference/trade#maximumamountin-since-204)用于滑点计算。

## 交易至价格

对于这个更高级的使用案例，请参阅[ExampleSwapToPrice.sol](https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/examples/ExampleSwapToPrice.sol)。