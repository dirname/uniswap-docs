---
id: oracles
title: 预言机
---

# 引言

预言机是用于查看特定资产价格信息的任何工具。当你在手机上查看股票价格时，你正在使用手机作为价格预言机。同样地，你手机上的应用程序依赖于设备来检索价格信息——很可能是多个，这些信息被聚合然后展示给你，最终用户。这些都是价格预言机。

在构建与DeFi协议集成的智能合约时，开发者不可避免地会遇到预言机问题。获取链上给定资产价格的最佳方式是什么？

以太坊上的许多预言机设计都是基于具体情况实施的，去中心化和安全性程度各不相同。正因为如此，生态系统见证了多次高调的黑客攻击，其中预言机实现是主要的攻击向量。
其中一些漏洞在这里进行了讨论[here](https://samczsun.com/taking-undercollateralized-loans-for-fun-and-for-profit/)。

虽然没有一种适用于所有情况的解决方案，但Uniswap V2使开发者能够构建高度去中心化且抗操纵的链上价格预言机，这可能满足构建稳健协议所需的许多需求。

# Uniswap V2 解决方案

Uniswap V2 包含了几个改进，以支持抗操纵的公共价格流。首先，每对交易对都会在每个区块开始前测量（但不存储）市场价，此时尚未发生任何交易。这个价格很难被操纵，因为它是由前一个区块中的最后一笔交易设定的，无论是铸造、交换还是销毁。

**为了将测量的价格设置为与全球市场价格脱节的价格，攻击者必须在前一个区块的末尾进行一笔糟糕的交易**，通常无法保证他们能在下一个区块中通过套利将其挽回。除非攻击者能够“自私地”连续开采两个区块，否则攻击者将亏损给套利者。这种类型的攻击存在几个挑战，到目前为止**[未被观察到](https://arxiv.org/abs/1912.01798)**。

不幸的是，这本身还不够。如果大量价值基于由此机制产生的价格进行结算，那么攻击者的利润很可能超过损失。

相反，Uniswap V2 在核心合约中将这个区块末尾的价格添加到单一累计价格变量中，按此价格存在的持续时间加权。**这个变量代表了整个合约历史中每秒的Uniswap价格之和。**

![](./images/v2_onchain_price_data.png)

外部合约可以利用此变量跟踪任何时间间隔内准确的时间加权平均价格（TWAP）。

TWAP是通过读取ERC20代币交易对在所需区间开始和结束时的累计价格构建的。然后，这个累计价格的差异可以除以区间的长度，从而为该期间创建一个TWAP。

![](./images/v2_twap.png)

TWAP可以直接使用或作为移动平均线（EMA和SMA）的基础，根据需要而定。

几点说明：

- 对于10分钟TWAP，每10分钟采样一次。对于一周TWAP，每周采样一次。
- 对于简单的TWAP，操纵成本（约线性）随着Uniswap上的流动性增加，以及（约线性）随着你平均的时间长度增加。
- 攻击的成本相对简单估计。在一小时TWAP上移动5%的价格大约等于移动价格5%每一区块一小时内所损失的套利和费用金额。

在使用Uniswap V2作为预言机时，特别是在抗操纵方面，有一些细节需要注意。[白皮书](/whitepaper.pdf)详细阐述了一些细节。近期将发布更多专注于预言机的开发者指南和文档。

在此期间，检查我们的[示例实现](https://github.com/Uniswap/uniswap-v2-periphery/blob/master/contracts/examples/ExampleOracleSimple.sol)，这是一个基于Uniswap V2构建的24小时TWAP预言机！

## 抗操纵性

对于特定时间段操纵价格的成本可以大致估算为整个期间每区块损失的套利和费用。对于更大的流动性池和更长的时间段，这种攻击是不切实际的，因为操纵成本通常超过风险中的价值。

其他因素，如网络拥堵，可能会降低攻击成本。要深入了解Uniswap V2价格预言机的安全性，请阅读[Oracle Integrity 安全审计部分](https://uniswap.org/audit.html#org87c8b91)。

# 构建预言机

要了解有关构建预言机的更多信息，请参阅开发人员指南中的[构建预言机](../../guides/smart-contract-integration/building-an-oracle)。