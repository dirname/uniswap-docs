---
id: common-errors
title: 常见错误
---

本文档涵盖了在构建 Uniswap V2 过程中经常遇到的一些错误代码。

# UniswapV2: K

这是一个经常遇到的错误，理解它需要一些上下文知识。

Uniswap 的常数乘积公式是“X * Y = K”。其中 X 和 Y 分别代表两种 ERC-20 代币的储备余额，“K”代表储备的乘积。这个“K”错误正是指的这个“K”。

本质上，“K”错误意味着尝试执行了一笔交易，这使得交易对的储备比应有的少，因此交易被回滚。

这可能有几种不同的原因。

## 收费转账代币

最常见的例子是由“收费转账”代币引起的。

### 包含式收费转账代币

在大多数情况下，收费转账代币会在每次转账时烧毁或转移一小部分，导致接收方收到的金额略少于发送方给出的金额。这被称为“包含式”收费转账。

对于包含式收费转账代币，您可以使用路由器合约中的对应交换函数，这些函数以["SupportingFeeOnTransfer"](../smart-contracts/router-02#swapexacttokensfortokenssupportingfeeontransfertokens)结尾。这些函数通过调整“amountOutMin”参数来检查接收方金额而不是发送方金额，从而在计算不变量时成功。

### 排他式收费转账代币

另一种类型，“排他式”收费转账代币，则是在主要转账后从发送地址进行额外的转账。由于路由器合约在计算不变量时无法预期这种尾随转账，因此交易要么回滚，要么部分成功地发送主要转账，但在尾随转账时破坏了池子。

对于排他式收费转账代币，SupportingFeeOnTransfer 函数可能会起作用，但有些代币设计得如此之特殊，它们从根本上打破了路由器。如果您在使用这些函数时仍然遇到“K”错误，您可能需要分叉路由器合约以适应您的代币设计。

## 重置代币

“K”错误的较少见情况是由于重置代币引起的。

重置代币可以任意改变持有其代币的任何地址的余额。这通常在预设的时间间隔内发生，并且是基于重置代币经济学中的一组变量的结果。

重置代币通常以两种方式工作。

### 负向重置代币

负向重置代币，更常见的变体，会降低代币持有者的余额。因为重置不由转账触发，路由器无法预期何时以及如何发生重置。一旦发生，交易对的储备将失去平衡，而下一个与该对交易的人将承担因重置产生的差额成本。

不用说，这可不是一个令人羡慕的位置。

负向重置代币通过修改其代币合约来解决此错误，在涉及 Uniswap 路由器合约的每笔交易结束时调用[sync](../smart-contracts/pair#sync)。那些有兴趣分叉路由器合约的人应该预料到，直到代币合约更新以适应您的新路由器，负向重置代币才会打破交易对。

### 正向重置代币

正向重置代币会任意增加代币持有者的余额。当正向重置发生时，它会产生交易对未计算在内的盈余。由于交易对中没有计入额外的代币，任何人都可以调用交易对上的 skim() 并有效地窃取重置产生的正面差异。

虽然正向重置不会破坏 Uniswap 的任何功能，但对此感兴趣的人应该意识到，任何交易对中发现的正余额都将可供自由获取。

### 关于重置代币的说明

对于那些有兴趣构建重置代币的人来说，这里有一个警告：许多涉及去中心化交易和流动性供应的合约在与您的代币交互时都会出错。一个将使未来协议更容易集成的方法可以在[CHAI](https://chai.money/about.html)中找到。CHAI 使用一个包装函数，将重置保留在包装器内部，这样可赎回代币就可以轻松地集成到许多不同的系统中。

# UniswapV2: LOCKED

LOCKED 错误是路由器合约中内置的一个保护措施，防止定制的再入合约在交易结束时试图将恶意代码返回到路由器合约中。

当使用 Ganache CLI 将以太坊主网分叉到本地实例作为开发环境的一部分时，经常会遇到这个错误。这个错误是 Ganache-Cli 的一个 bug，希望在未来版本中由 truffle 团队修复。

一个临时修复方法是简单地重新启动本地分叉。

# 无法访问归档节点

这是 Metamask 或 Ganache-CLI 的一个错误。通常发生在本地分叉实例化后，合约已部署，但有一笔失败的交易。

一个临时修复方法是通过重新启动本地分叉并重置 metamask 来实现。

# UniswapV2: TRANSFER_FAILED

这意味着核心合约无法将代币发送给接收者。这很可能是因为一个欺诈性代币，代币所有者恶意禁用了转账功能，使得用户能够购买代币，但不能卖出。

# UniswapV2: EXPIRED

这是由于一笔交易花费了太长时间才广播到主网。

Uniswap 本身不设置燃气费用，因此大多数用户默认使用 metamask 中建议的燃气费用。但有时 metamask 会判断错误，设置的燃气价格过低。如果一笔交易超过20分钟还未执行，核心合约将不允许其继续进行。

# 需要一个活跃的储备才能执行操作

处理交易时的 VM 异常：需要一个活跃的储备才能执行操作

在处理闪贷时遇到可能是 ganache 的 bug。我们尚未找出其来源。

# 无法在前端批准交易

在某些罕见的情况下，用户无法在 Uniswap 前端批准代币。

这是由于某些代币合约采取措施防御恶意合约试图抢先批准并窃取用户的代币。仅当用户试图将一个预分配金额的批准限额增加到更大的金额时才会发生这种情况，而且只发生在少数代币合约上。

解决方案是让用户手动将路由器合约的批准金额设置为零，然后设置为他们想要的数字。最简单的方法是通过 Etherscan。